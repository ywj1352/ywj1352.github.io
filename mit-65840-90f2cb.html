<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;/icons/infinity_gray.svg&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>MIT 6.5840&nbsp;|&nbsp;humblog</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="MIT 6.5840">
  
    <meta name="description" content="MIT 6.5840 note">
    <meta property="og:description" content="MIT 6.5840 note">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;â•&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;/icons/infinity_gray.svg&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸŒ–&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>About</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;â•&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">MIT 6.5840</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Fri, Apr 28, 2023</span>
        
        
      </div>
    
  </header>
  <article id="https://www.notion.so/90f2cb4490ab40b7a73602bfb83a314c" class="PageRoot"><div id="https://www.notion.so/4fea7cb88f1c458694d52a635a708e31" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">ğŸ˜‡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">All I need to know about 6.5840
Full code on:
</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/humbornjo/MIT-6.5840">https://github.com/humbornjo/MIT-6.5840</a></span></span></p></div><h1 id="https://www.notion.so/0703010f5ea445708782154f65ffcbc1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/0703010f5ea445708782154f65ffcbc1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Lab1</span></span></h1><div id="https://www.notion.so/6a7812d7dfe44fbfbbc0835caa7d792e" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">ğŸ’¡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">è™½ç„¶æœ¬æ¬¡å®éªŒæ²¡æœ‰è§¦åŠï¼Œä½†æ˜¯GFSæ‰æ˜¯Map Reduceçš„çµé­‚ã€‚è¿™ä¹Ÿæ˜¯å¾ˆå¤šMRæ–¹æ³•å±€é™åœ¨å•æœºè¿è¡Œçš„æ ¹æœ¬åŸå› ã€‚åœ¨åˆ†å¸ƒå¼çš„åœºæ™¯ä¸­ï¼Œintermediateçš„äº¤æ¢æ‰æ˜¯äº‹å®ä¸Šçš„é‡ç‚¹ã€‚</span></span></p></div><h2 id="https://www.notion.so/296cfffe10bd42959678e7d7fd9eee2b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/296cfffe10bd42959678e7d7fd9eee2b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Difficulties &amp; solution</span></span></h2><details id="https://www.notion.so/07f94d181c3c45229de94b95d5c4a094" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">coordinator ä½œä¸ºè°ƒåº¦è€…ï¼Œå°±ç®—å…¶å…ƒç´ éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¾ç„¶æ˜¯éœ€è¦åŠ ä¸€ä¸ªæ•´ä½“çš„é”çš„ã€‚ï¼ˆä»…é’ˆå¯¹æˆ‘çš„è®¾è®¡ä¸å®ç°ï¼‰</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/47bcae09dd704889bae09d40b1e01577" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>type Coordinator struct {
	// Your definitions here.
	nMap     int
	nReduce  int
	stage    int
	currTask chan Task
	runnTask map[Task]chan int
	lock     sync.RWMutex
}</span></span></span></code></pre><div id="https://www.notion.so/c733117872be43bf9f39938235ecf66a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åœ¨æˆ‘çš„å®ç°ä¸­ï¼Œå½“currTaskå’ŒrunnTaskå…¨ä¸ºç©ºæ—¶æ–¹å¯è§¦å‘stageçš„è½¬æ¢ï¼ˆæ¯”å¦‚ä»MAPè½¬ç§»åˆ°REDUCEï¼‰ã€‚å¦‚æœåˆ†åˆ«åŠ é”ï¼Œå°±å¯èƒ½å¯¼è‡´ â†’ </span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/11077199901542b697ddbdcd720f5c5d" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">æ£€æŸ¥currTaskæ—¶ä¸ºç©º</span></span></li><li id="https://www.notion.so/94a245bd7d5e4215a0a40543d974d67c" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">runnTaskè¶…æ—¶ï¼Œåˆ é™¤ä»»åŠ¡ï¼Œæœªå®Œæˆçš„ä»»åŠ¡é‡æ–°å…¥é˜ŸcurrTask</span></span></li><li id="https://www.notion.so/acba106738cf473ebe5ce58eb723fcd8" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">æ£€æŸ¥runnTaskï¼Œä¹Ÿä¸ºç©º</span></span></li><li id="https://www.notion.so/3841d2c747ac472bbe430430dc7762ee" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">çŠ¶æ€è½¬æ¢äº†ï¼ŒMRå¤±è´¥</span></span></li></ol></div></details><details id="https://www.notion.so/26896ccd47a84f4185aa94064e9f1d42" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">rpcçš„è®¾è®¡ä¸ç»†èŠ‚</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/d414d212a25c4eab9ae3cade1b201d03" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>/*
type Task struct {
	Tid   int
	Fname string
}
*/

type AskForTaskArgs struct {
	Wid int
}

type AskForTaskReply struct {
	Stage int
	Task  Task
	Nout  int
}

type ReportForTaskArgs struct {
	Task Task
}

type ReportForTaskReply struct {
	Foo bool
}</span></span></span></code></pre><div id="https://www.notion.so/8a34e1f6a04146828048854cb704904a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æ€»ä½“åˆ†ä¸ºAskå’ŒReportä¸¤ç§ï¼Œä¸»è¦çš„é—®é¢˜åœ¨äºReport RPCå‰åä¸´æ—¶æ–‡ä»¶çš„ä¿å­˜å’ŒçŠ¶æ€çš„è½¬å˜ï¼Œä¸‹é¢è¿›è¡Œåˆ†ç±»åˆ†æã€‚</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/75d0c4c6816449fd8dbf7dcc4c7acc87" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">MAPé˜¶æ®µçš„Report,æ˜¯åœ¨RPCè·å¾—trueçš„å›å¤åè¿›è¡Œä¿å­˜ä¸´æ—¶æ–‡ä»¶ï¼Œè¿˜æ˜¯å…ˆä¿å­˜ä¸´æ—¶æ–‡ä»¶ï¼Œå†call RPCã€‚</span></span><ol class="NumberedListWrapper"><li id="https://www.notion.so/5c2dbbebbf874e6984b17b6b43d2081b" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">å¦‚æœåœ¨è·å¾—RPCå›å¤åå†ä¿å­˜ã€‚å¦‚æœRPCç»“æœä¸ºtrueï¼ˆåœ¨æˆ‘çš„å®ç°ä¸­ï¼Œæ˜¯</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">reply.Foo == true</code></span><span class="SemanticString">ï¼‰ã€‚ä¼šå‡ºç°ä¸€ä¸ªææ€–çš„äº‹ï¼Œé‚£å°±æ˜¯coordinatorå·²ç»è½¬æ¢çŠ¶æ€äº†ã€‚å¼€å§‹åˆ†å‘REDUCEçš„ä»»åŠ¡äº†ï¼Œä½†æ˜¯MAPé˜¶æ®µçš„intermediateæ–‡ä»¶è¿˜æ²¡æœ‰ä¿å­˜å®Œã€‚è¿™å°±ä¼šå¯¼è‡´ï¼Œå¦‚æœæœ‰ä¸€ä¸ªWorkeræ­¤æ—¶æ°å¥½æ¥äº†ä»»åŠ¡ï¼Œå¹¶ç«äº‰è¿è¡Œäº†ï¼Œç„¶è€Œç›®æ ‡æ–‡ä»¶ç”šè‡³ä¸å­˜åœ¨ï¼Œæœ€ç»ˆREDUCEçš„ä»»åŠ¡ç»“æœå‡ºé”™ã€‚å¦‚æœRPCç»“æœä¸ºfalseï¼Œå½±å“ä¸å¤§ï¼Œå°±ç®—ä¿å­˜äº†ä¹Ÿä¼šè¢«å¦ä¸€ä¸ªWorkerçš„æ–‡ä»¶å†™å…¥æ›¿æ¢ã€‚</span></span></li><li id="https://www.notion.so/b3dccb9dbddc471c949129778439f0d9" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">å¦‚æœåœ¨è·å¾—RPCå›å¤å‰å†ä¿å­˜ã€‚å¦‚æœRPCç»“æœä¸ºtrueï¼Œä¸ä¼šæœ‰ä»»ä½•é—®é¢˜ï¼Œè§£å†³äº†ä¸Šæ–¹çš„é—®é¢˜ã€‚å¦‚æœRPCç»“æœä¸ºfalseï¼Œå½±å“ä¸å¤§ï¼Œå°±ç®—ä¿å­˜äº†ä¹Ÿä¼šè¢«å¦ä¸€ä¸ªWorkerçš„æ–‡ä»¶å†™å…¥æ›¿æ¢ã€‚</span></span></li><li id="https://www.notion.so/894eadb3c6c940e49ebf9030f692fb36" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">ç»¼ä¸Šï¼Œé€‰æ‹©åœ¨RPCå›å¤å‰ä¿å­˜ã€‚</span></span></li></ol></li><li id="https://www.notion.so/4009226cd42246d584e86f4286a963ab" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">Reduceé˜¶æ®µçš„Reportï¼Œæ²¡å•¥å¥½è¯´çš„ï¼Œä¿å­˜å¿…ç„¶æ˜¯åœ¨RPCä¹‹å‰çš„ï¼Œå› ä¸ºå®ç°borrowäº†mrsequentialçš„ä»£ç ï¼Œç›®å‰æ¥çœ‹ï¼Œæ¢æˆåœ¨RPCä¹‹åé˜»å¡åœ°ä¿å­˜ï¼Œå”¯ä¸€çš„é£é™©å°±æ˜¯Workerçš„ä¸´æ—¶å®•æœºã€‚ï¼ˆæœ€åä¸è¦å¿˜äº†åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼‰</span></span><pre id="https://www.notion.so/ed373ccba8f941f78a91db447f84d4a1" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>if !ReportForTask(
	&amp;ReportForTaskArgs{Task: reply.Task}, 
	&amp;ReportForTaskReply{}) {
	os.Remove(oname)
} else {
	for _, filename := range filenames {
		os.Remove(filename)
	}
}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/a68d9dc391324d01aeaba4f89b0f5ffa" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/5758a079a85748828d725dd9880298fe" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>MIT-6.5840/src/main via ğŸ¹ v1.20.6 
<span class="token operator">></span> <span class="token function">bash</span> test-mr.sh
*** Starting <span class="token function">wc</span> test.
--- <span class="token function">wc</span> test: PASS
*** Starting indexer test.
--- indexer test: PASS
*** Starting map parallelism test.
--- map parallelism test: PASS
*** Starting reduce parallelism test.
--- reduce parallelism test: PASS
*** Starting job count test.
--- job count test: PASS
*** Starting early <span class="token builtin class-name">exit</span> test.
--- early <span class="token builtin class-name">exit</span> test: PASS
*** Starting crash test.
--- crash test: PASS
*** PASSED ALL TESTS</span></span></span></code></pre></div></div><h1 id="https://www.notion.so/2f89eebb5c8a4ef1b83fd139159ae06f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/2f89eebb5c8a4ef1b83fd139159ae06f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Lab2</span></span></h1><div id="https://www.notion.so/91bcb824b0214818aa8f0421831634bc" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">ğŸ’¡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">What u deserve to understand is that, even raft can make mistake. When the delay is high and command flood in.</span></span></p></div><h2 id="https://www.notion.so/ce15b884233f456ba292ead5012cc38b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/ce15b884233f456ba292ead5012cc38b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Core Idea</span></span></h2><ol class="NumberedListWrapper"><li id="https://www.notion.so/ec1c4cce0e354ae09b392b350c5ef46c" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">Raft RPCS is idempotent</span></span></li><li id="https://www.notion.so/fdce6afb89994694af8337a877bd2f19" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">Randomization causes simplicity</span></span></li><li id="https://www.notion.so/fad1b278e9f7469da2093b29f6f2d22b" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">Leader takes it all</span></span></li><li id="https://www.notion.so/0163d30d48dc4be49bb8998045bcb6eb" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">Logical timing instead of physical timing</span></span></li></ol><p id="https://www.notion.so/7f06ab4796654848a3238790bea1b417" class="Equation" data-latex="broadcastTime â‰ª electionTimeout â‰ª MTBF"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>r</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi>c</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>â‰ª</mo><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>u</mi><mi>t</mi><mo>â‰ª</mo><mi>M</mi><mi>T</mi><mi>B</mi><mi>F</mi></mrow><annotation encoding="application/x-tex">broadcastTime â‰ª electionTimeout â‰ª MTBF</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">â‰ª</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mord mathdefault">o</span><span class="mord mathdefault">u</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">â‰ª</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span></span></span></span></span></p><h2 id="https://www.notion.so/1410681baf994644a532736f7b5fbf06" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/1410681baf994644a532736f7b5fbf06"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Mind Trail</span></span></h2><a id="https://www.notion.so/e859552bc59749ed9edefab320fafd87" class="Page" href="https://www.notion.so/e859552bc59749ed9edefab320fafd87"><div><div class="Page__Icon"><div class="Icon">âœ”ï¸</div></div><div class="Page__Title"><span class="SemanticStringArray"><span class="SemanticString">lab2 Raft</span></span></div></div></a><h2 id="https://www.notion.so/06cec3b4463b40aa8f510441fa460a7d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/06cec3b4463b40aa8f510441fa460a7d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Difficulties &amp; solution</span></span></h2><h3 id="https://www.notion.so/8fda6a121f014aca96385a822c2d4a4f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/8fda6a121f014aca96385a822c2d4a4f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2A</span></span></h3><div id="https://www.notion.so/ccae0057c6a7425db4f9d9c2e6c6879e" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">Termä¸¥æ ¼å°çš„æ‰èƒ½ç»™Termå¤§çš„serveræŠ•ç¥¨ï¼Œä½†æ˜¯å®¹æ˜“å‡ºç°ä»¥ä¸‹æƒ…å†µ (å¿½ç•¥ç¬¬ä¸‰åˆ—)ï¼Œå³server S1å’ŒS2å‡ ä¹ä»¥åŒä¸€æ—¶é—´å¼€å§‹é€‰ä¸¾ (å³ä½¿å­˜åœ¨éšæœºtimeout)ï¼Œå¯¼è‡´å¤šè½®éƒ½æ— æ³•é€‰å‡ºleaderã€‚</span></span></del></div></div></div><details id="https://www.notion.so/9cbe30420f1a4980800cefebcae97eb5" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/717c290143c4465c8f4941eb6402ed80" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 C0 ask for vote, T: 8                                                                                                                                     
S0 not leader, election timeout...                                                                                                                           
S0 convert to candidate, calling election T: 7                                                                                                               
                                                                                                         S2 C0 ask for vote, T: 8                            
                                                     S1 C0 ask for vote, T: 8                                                                                
S0 not leader, election timeout...                                                                                                                           
S0 convert to candidate, calling election T: 8                                                                                                               
                                                                                                         S2 C0 ask for vote, T: 9                            
                                                     S1 not leader, election timeout...                                                                      
                                                     S1 convert to candidate, calling election T: 8                                                          
                                                                                                         S2 C0 ask for vote, T: 9                            
                                                     S1 C0 ask for vote, T: 9                                                                                
S0 C0 ask for vote, T: 9                                                                                                                                     
S0 not leader, election timeout...                                                                                                                           
S0 convert to candidate, calling election T: 9                                                                                                               
                                                                                                         S2 C0 ask for vote, T: 10                           
                                                     S1 C0 ask for vote, T: 10                                                                               
                                                     S1 not leader, election timeout...                                                                      
                                                     S1 convert to candidate, calling election T: 9                                                          
                                                                                                         S2 C0 ask for vote, T: 10                           
S0 C0 ask for vote, T: 10                                                                                                                                    
S0 -&gt; S1 vote false, VT: 0                                                                                                                                   
S0 not leader, election timeout...                                                                                                                           
S0 convert to candidate, calling election T: 10</span></span></span></code></pre></div></details><details id="https://www.notion.so/88d1c5c3cfdc476cba63b66e05cfd3a8" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/9f6b136279a04e76bb9c488741092eb0" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Commented">åœ¨RequestVote RPCsä¸­å°±æ›´æ–°äº†è‡ªå·±çš„Termï¼Œä½¿å¾—è½åçš„serverä¸€ä¸‹å­å°±è¿½ä¸Šäº†å› randomè€Œé¢†å…ˆçš„server</span></span></span></li><li id="https://www.notion.so/ab3313a308dd4d81889f3800762afdf3" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">timeoutåŒºé—´ä¸º [150, 300] ms</span></span></li></ol></div></details><details id="https://www.notion.so/6098651cb9b94eef8ec1401e7d5bd068" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">å¯èƒ½çš„è§£å†³åŠæ³•</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/10c66b52f65a464a946f904461927692" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><del class="SemanticString__Fragment SemanticString__Fragment--Strike"><span class="SemanticString__Fragment SemanticString__Fragment--Commented">ä¸åœ¨RequestVote RPCsä¸­æ›´æ–°Termã€‚</span></del></span><span class="SemanticString"><del class="SemanticString__Fragment SemanticString__Fragment--Strike">
</del></span><span class="SemanticString">åœ¨æ›´æ–°ä»¥åæŠŠisTimeoutç½®ä¸ºfalseï¼Œè·³è¿‡ä¸€è½®é€‰ä¸¾è‡ªå¢ã€‚</span></span></li><li id="https://www.notion.so/3390de38abe54ec7a00af61d6d36ff50" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">å¢å¤§timeoutçš„åŒºé—´</span></span></li></ol></div></details><details id="https://www.notion.so/e3b56ee97f5a4e38b74edfbeb5b3dd27" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/99e07b3d7e9c44e68d011324838d642b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Commented">é‡‡ç”¨äº†æ–¹æ³•1ï¼Œå¹¶å°†timeoutåŒºé—´ä¿®æ”¹ä¸º [200, 500] msï¼Œæš‚æ—¶è§£å†³é—®é¢˜ã€‚</span></span></span></p></div></div></details><div id="https://www.notion.so/40ce5f649be142a58a082bb23681349c" class="Divider"></div><div id="https://www.notion.so/ffa158db379048eb854c36ed6bb37f39" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">è§‚å¯Ÿç¬¬äºŒåˆ—å’Œæœ€åä¸€åˆ—ï¼Œå¯ä»¥å‘ç°è¿™é‡Œ S1 å’Œ S6 å‡ºç°äº†è„‘è£‚ç°è±¡ï¼Œä½†æ˜¯å¹¶æœªå¾—åˆ°è§£å†³ã€‚åŸå› æ˜¯ä¸¤æ–¹æ­¤æ—¶çš„Termç›¸åŒï¼Œä¸¤æ–¹äº’ç›¸ä¼šæ‹’ç»å¯¹æ–¹çš„heartbeat logè€Œä¸ä¼šè¿›è¡ŒçŠ¶æ€è½¬æ¢ã€‚</span></span></del></div></div></div><details id="https://www.notion.so/ece1fc7b435549fa8790878f4a1b0417" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/3dc9485d23b54c669ec603ee74f6fd74" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>                       S1 multi leaders(2)                                                                                                                 
                       T: 7                                                                                                                                
                                                                                                                                     S6 multi leaders(2) T:
                                                                                                                                     7                     
                                                                                                                                     S6 -&gt; S5 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                       S1 -&gt; S6 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                                             S2 convert to                                                                                                 
                                             candidate, calling                                                                                            
                                             election T: 7                                                                                                 
                                                                                                                                     S6 C0 ask for vote, T:
                                                                                                                                     8                     
                                                                                                                                     S6 -&gt; S0 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                                                                                                                                     S6 -&gt; S1 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                                                                                                                                     S6 -&gt; S2 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                                                                                                                                     S6 -&gt; S3 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                                                                                                                                     S6 -&gt; S4 T: 7, send   
                                                                                                                                     {PLI: 0, PLT: 0}      
                       S1 -&gt; S0 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                       S1 -&gt; S2 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                       S1 -&gt; S3 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                       S1 -&gt; S4 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}                                                                                                                    
                       S1 -&gt; S5 T: 7, send                                                                                                                 
                       {PLI: 0, PLT: 0}</span></span></span></code></pre></div></details><details id="https://www.notion.so/bde5ab9f97394bcabb700231baead007" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/d87d7f54117345cc86fd4b3521f42370" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">Termç›¸åŒï¼Œåœ¨èº«ä¸ºleaderçš„åŒæ—¶å¯¹å³™ï¼Œç”±äºæ‹’ç»äº†heartbeat logå¯¼è‡´çš„çŠ¶æ€æ— æ³•è½¬æ¢</span></span></li></ol></div></details><details id="https://www.notion.so/66b08f6eed954968afbd62000abf2564" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">å¯èƒ½çš„è§£å†³æ–¹æ³•</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/2398abcec87d4b7e96386e657804e279" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">æœ¬è´¨ä¸Šæ˜¯åœ¨disconnectçš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥è‡ªå·±çš„killed()ï¼ŒåŠæ—¶è½¬æ¢ä¸ºfollowerã€‚è®ºæ–‡ä¸­æ²¡æœ‰æåˆ°Termç›¸åŒçš„æƒ…å†µä¸‹Entry (Including heartbeat)çš„å¤„ç†æƒ…å†µã€‚</span></span></li></ol></div></details><details id="https://www.notion.so/7117de1a111c4fea8ee93119448e1341" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/c6d77f27a36e46c9ac4bf1b2be0ca3fd" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åœ¨æ¯ä¸ªheartbeat loopä¸­æ£€æŸ¥killed()ï¼ŒåŠæ—¶è½¬æ¢çŠ¶æ€ã€‚</span></span></li><li id="https://www.notion.so/e46a8debef554986b4476e074aacca01" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">è¿è¡Œæ—¶åˆå‘ç°äº†ä¸€ä¸ªå°é—®é¢˜ï¼Œä¸‹é¢åˆ†æå‡ºé—®é¢˜çš„ä»£ç ã€‚AppendEntryåˆ†ä¸ºä¸‰ä¸ªæƒ…å†µï¼ŒcurrTerm &lt; args.Term, currTerm = args.Term å’Œ currTerm &gt; args.Termã€‚</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ç¬¬ä¸€ç§æƒ…å†µ</strong></span><span class="SemanticString">æ²¡å•¥å¥½è¯´çš„ï¼Œ</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ç¬¬äºŒç§æƒ…å†µä¸‹</strong></span><span class="SemanticString">ï¼Œè‹¥serverè¿˜æœªæŠ•ç¥¨ (voteFor == -1) åˆ™serverä¸€å®šä¸æ˜¯Leaderï¼›æŠ•äº†ç¥¨çš„æƒ…å†µä¸‹æ‹’ç»å¯ä»¥ä¿è¯ä¸€ä¸ªTermåªæŠ•ä¸€æ¬¡ç¥¨çš„åŸåˆ™ã€‚ç¬¬ä¸‰ç§æƒ…å†µä¸‹ï¼Œéœ€è¦æ³¨æ„ï¼Œserverçš„çŠ¶æ€å¯èƒ½æ˜¯ä¸‰ä¸ªçŠ¶æ€ä¸­çš„ä»»æ„ä¸€ç§ï¼Œæ‰€ä»¥ä¸€å®šè¦é‡ç½®serverçš„çŠ¶æ€ä¸ºFolloweræ¥ä¿è¯Termå¤§çš„ä¼˜å…ˆçš„åŸåˆ™ã€‚</span></span></li></ol><pre id="https://www.notion.so/c5859f3bb86744d983888cd2e927df18" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>if rf.currTerm &gt; args.Term {
	reply.VoteGranted = false
	DebugLog(dVote, &quot;S%d -&gt; S%d vote false, T: %d, CT: %d\n&quot;, rf.me, args.CandidateId, rf.currTerm, args.Term)
	return
} else if rf.currTerm == args.Term {
	if rf.votedFor == -1 {
		rf.votedFor = args.CandidateId
		reply.VoteGranted = true
		DebugLog(dVote, &quot;S%d -&gt; S%d vote true, same term\n&quot;, rf.me, args.CandidateId)
		return
	} else {
		reply.VoteGranted = false
		DebugLog(dVote, &quot;S%d -&gt; S%d vote false, VT: %d\n&quot;, rf.me, args.CandidateId, rf.votedFor)
		return
	}
} else {
	rf.currTerm = args.Term
	rf.isTimeout = false
	rf.state = Follower // !!!!!!!!!!!!!! IMPORTANT !!!!!!!!!!!!!!
	rf.votedFor = args.CandidateId
	reply.VoteGranted = true
	DebugLog(dVote, &quot;S%d -&gt; S%d vote true, from T: %d to CT: %d\n&quot;, rf.me, args.CandidateId, reply.Term, rf.currTerm)
	return
}</span></span></span></code></pre></div></details><div id="https://www.notion.so/6520764208e24fa89463c98fc2f1b754" class="Divider"></div><div id="https://www.notion.so/7f2d55b4f5604c08ad854c7fc4aeff56" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/12b36140689b47f0b5997df3fd1a0502" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>humborn@shin MIT-6.5840/src/raft on master [!] [!]                                                                                        ó±‘† 09:36:06
 âœ go test -run 2A                                    
Test (2A): initial election ...
  ... Passed --   3.0  3   58   15440    0
Test (2A): election after network failure ...
  ... Passed --   4.4  3  140   27904    0
Test (2A): multiple elections ...
  ... Passed --   6.2  7  686  129664    0
PASS
ok      6.824/raft      13.599s</span></span></span></code></pre></div></div><div id="https://www.notion.so/7d61923ef9d7430da0fdba2deec4cd5f" class="Divider"></div><div id="https://www.notion.so/45803a46eeeb4226a3a851ce0dd2831e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h3 id="https://www.notion.so/f68ac6e6407f4899a5664814ab46ba1b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/f68ac6e6407f4899a5664814ab46ba1b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2B</span></span></h3><div id="https://www.notion.so/b1792bb57e2d4c9380d78b5d114fdaed" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">Serveråœ¨æˆåŠŸappendä»¥åï¼Œç«Ÿç„¶æ²¡æœ‰è®©Leaderæ›´æ–°commitIndex</span></span></del></div></div></div><details id="https://www.notion.so/bbf521e5f6c14ce7a0792bd83247ca05" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/142215d0ecb24b2ea86f820e565dc39b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 not leader, election timeout...                                                                                                                         
                                        S1 -&gt; S2 T: 1, send {PLI: 0, PLT: 0,                                                                               
                                        CI: 0}                                                                                                             
                                        S1 -&gt; S0 T: 1, send {PLI: 0, PLT: 0,                                                                               
                                        CI: 0}                                                                                                             
S0 -&gt; S1 append ok T: 1, LENLOG: 2                                                                                                                         
                                                                               S2 -&gt; S1 append ok T: 1, LENLOG: 2                                          
                                                                               S2 not leader, election timeout...                                          
                                        S1 -&gt; S2 T: 1, send {PLI: 1, PLT: 1,                                                                               
                                        CI: 0}                                                                                                             
                                        S1 -&gt; S0 T: 1, send {PLI: 1, PLT: 1,                                                                               
                                        CI: 0}                                                                                                             
S0 -&gt; S1 append ok T: 1, LENLOG: 2                                                                                                                         
                                                                               S2 -&gt; S1 append ok T: 1, LENLOG: 2                                          
                                        S1 -&gt; S2 T: 1, send {PLI: 0, PLT: 0,                                                                               
                                        CI: 0}                                                                                                             
                                        S1 -&gt; S0 T: 1, send {PLI: 0, PLT: 0,                                                                               
                                        CI: 0}                                                                                                             
S0 -&gt; S1 append ok T: 1, LENLOG: 2                                                                                                                         
                                                                               S2 -&gt; S1 append ok T: 1, LENLOG: 2                                          
FAIL
FAIL    6.824/raft      2.313s</span></span></span></code></pre></div></details><details id="https://www.notion.so/8f84e472c6824e799c6e7550e2761bb2" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/90eb7793afb044ec9e7758c3a853c853" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">sortä¸­ç´¢å¼•æœ‰é—®é¢˜ï¼ŒåŸæ¥æ˜¯ä»å°åˆ°å¤§æ’åºåï¼Œå–len(rf.peers)/2-1ï¼Œå½“#Serverä¸º3æ—¶ï¼Œç»“æœä¸º0,å¾ˆæ˜¾ç„¶ä¸å¯¹ã€‚</span></span></li><li id="https://www.notion.so/4cbb7bc0f1584937863e4e125ffc7180" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">æé”™ç´¢å¼•äº†ï¼ŒAppendEntriesæ—¶å¯èƒ½ä¼šä¼ å…¥ç©ºEntriesã€‚è¿™æ—¶æƒ³æ™®é€‚åœ°æ»¡è¶³AppendEntries RPCsçš„æœ€åä¸€æ¡å®ç°è§„åˆ™ï¼Œå°±éœ€è¦å–serverè‡ªèº«logEntriesçš„æœ€åä¸€æ¡entryçš„index</span></span></li><li id="https://www.notion.so/15eb0916cab1497eb28e5adac5a17953" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">åˆ›å»ºæ–°logEntryæ—¶indexå’Œtermä½ç½®åäº†ï¼Œcao!</span></span></li></ol></div></details><details id="https://www.notion.so/fe54db70c4c246e9b07ca98f5b3e5eab" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/580979e2b4e0483b8a8d5ed16b39ed17" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">æ”¹ä¸º(len(rf.peers)-1)/2</span></span></li><li id="https://www.notion.so/014a396ec19f43fa9d46c121d16740e4" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">ç”±args.Entriesâ†’rf.logEntrieså–æœ€åä¸€ä¸ªentryçš„index</span></span></li><li id="https://www.notion.so/d633ab54fee44cb9b96c2aaeb40afec5" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">caoï¼</span></span></li></ol></div></details><details id="https://www.notion.so/66fd91b4eec74a219a074f46cff6140b" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Task log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/0f5c9f21cb174254be37d4b48977fd71" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>âœ go test -run BasicAgree                          
Test (2B): basic agreement ...
  ... Passed --   0.5  3   16    4258    3
PASS
ok      6.824/raft      0.494s</span></span></span></code></pre></div></details><div id="https://www.notion.so/e3b7e099818d489a8a5cb77b3dd440d3" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">å¦‚æœä¸€ä¸ªserveræ‰çº¿äº†ï¼Œä¼šä¸æ–­</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">StartElection()</code></span><span class="SemanticString">è‡ªå¢ï¼Œå½“å®ƒé‡è”æ—¶ï¼Œå®ƒçš„Termå°†ä¼šå¾ˆå¤§ã€‚å°±ä¼šå¯¼è‡´ä¸€ä¸ªæƒ…å†µï¼Œå½“å‰ leader çš„ AppendEntries RPCs å°†ä¼šè¢«æ‹’ç»ï¼Œreplyä¸­çš„Termå·¨å¤§ï¼Œä¼šå°†Leaderæ‰“å›Followerå¹¶æ›´æ–°Term,æœ€å¥½ç»™Leaderç‰¹æƒï¼Œè®©Leaderå°½å¿«timeout,å†æ¬¡æˆä¸ºLeaderï¼›ç”±å®ƒå¬å¼€çš„Electionä¹Ÿä¼šè¢«å…¶ä»–serveræ‹’ç»(LastLogIndexå¾ˆå°)å¹¶ä½¿å…¶ä»–serveræ›´æ–°Termï¼Œä¸ç”¨ç»™ç‰¹æƒé€šé“ã€‚ä½†æ˜¯åœ¨ä¸‹æ–¹logä¸­
</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">S0 apply msg: {true 101 1 false [] 0 0} 
</em></span><span class="SemanticString">é‡å¤å‡ºç°ï¼Œä¸”é‡è”åï¼Œå¹¶æœªä¸€ç›´å°è¯•Append(åœ¨ç¬¬ä¸€æ¬¡è¢«æ‹’ç»å)å¯¼è‡´æ²¡æœ‰åŠæ—¶æ›´æ–°ã€‚</span></span></del></div></div></div><details id="https://www.notion.so/36cfd6f083224a4ea2b93b2577393204" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/86f22189aaf7417c8f607be813917919" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 reconnect...                                                                                                                                                
                                                                                                           S2 recv command, LENLOG: 6, T: 1                    
                                                                                                           S2 send to S1, ENTRIES: [{106 1 6}]                 
                                                                                                           S2 send to S0, ENTRIES: [{102 1 2} {103 1 3} {104 1 
                                                                                                           4} {105 1 5} {106 1 6}]                             
                                                      S1 recv append from S2, T: 1, ENTRIES: [{106 1 6}]                                                       
                                                      S1 -&gt; S2 append ok T: 1, LENLOG: 7                                                                       
S0 recv append from S2, T: 1, ENTRIES: [{102 1 2}                                                                                                              
{103 1 3} {104 1 4} {105 1 5} {106 1 6}]                                                                                                                       
S0 append fail, T: 6 large term                                                                                                                                
                                                                                                           S2 -&gt; S1 T: 1, send {PLI: 5, PLT: 1, CI: 5,         
                                                                                                           BEGINLOGIDX: 6, ENDLOGIDX: 6, LOG: [{106 1 6}]}     
                                                                                                           S2 update commitIndex CI: 6                         
                                                                                                           S2 apply msg: {true 106 6 false [] 0 0}             
                                                                                                           S2 -&gt; S0 T: 1, send {PLI: 1, PLT: 1, CI: 5,         
                                                                                                           BEGINLOGIDX: 2, ENDLOGIDX: 6, LOG: [{102 1 2} {103 1
                                                                                                           3} {104 1 4} {105 1 5} {106 1 6}]}                  
                                                                                                           S2 convert to candidate, calling election T: 6      
                                                      S1 C6 ask for vote, T: 7                                                                                 
S0 C6 ask for vote, T: 7                                                                                                                                       
                                                      S1 -&gt; S2 vote true, from T: 1 to CT: 7                                                                   
S0 -&gt; S2 vote true, from T: 6 to CT: 7                                                                                                                         
                                                                                                           S2 convert to leader at T: 7                        
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
                                                      S1 apply msg: {true 106 6 false [] 0 0}                                                                  
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 6                     
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 5                     
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 4                     
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, fail send {PLI: 1, PLT: 1, CI: 4}    
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 3                     
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 append fail, diff term                                                                                                                                      
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 update failed, NEXT: 2                     
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 -&gt; S2 recv heartbeat                                                                                                                                        
S0 apply msg: {true 101 1 false [] 0 0}                                                                                                                        
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat                       
                                                                                                           S2 -&gt; S0 T: 7, fail send {PLI: 1, PLT: 1, CI: 3}    
                                                      S1 recv append from S2, T: 7, ENTRIES: []                                                                
                                                      S1 -&gt; S2 recv heartbeat                                                                                  
                                                                                                           S2 -&gt; S1 T: 7, send heartbeat                       
S0 recv append from S2, T: 7, ENTRIES: []                                                                                                                      
S0 -&gt; S2 recv heartbeat                                                                                                                                        
                                                                                                           S2 -&gt; S0 T: 7, send heartbeat</span></span></span></code></pre></div></details><details id="https://www.notion.so/2eef3b428ec04fdb8b982999f466add1" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/110ce0e9be8741f29eac6b821559db24" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åªè¦leaderCommitæ¯”è‡ªå·±çš„commitIdè¦å¤§ï¼Œå°±ä¼šä¿¡å·æç¤ºapplyMsgã€‚</span></span></li><li id="https://www.notion.so/f7eb0abc28074808bfdfab6d37b08ce1" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">é‡è”åä¼šé‡æ–°é€‰ä¸¾Leaderï¼Œä¹Ÿå°±æ˜¯è¯´é‡æ–°é€‰å‡ºçš„Leaderä¼šé‡æ–°åˆå§‹åŒ–è‡ªå·±çš„nextIndexã€‚è‡ªç„¶çš„ï¼Œç¬¬ä¸€æ¬¡å°è¯•å¯¹é‡è”çš„Serverè¿›è¡Œappendä¼šå› ä¸ºæ²¡æœ‰åŒ¹é…çš„indexè€Œè¢«æ‹’ç»ï¼Œäºæ˜¯å¯„äº†ã€‚</span></span></li></ol></div></details><details id="https://www.notion.so/6c49599a91ff4915b7d9841d4ff4e13d" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/c9e22b19f67546dabb5c237852e753be" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">ä¸å†å¯¹heartbeatç‰¹æ®Šå¯¹å¾…ï¼Œä¹Ÿå°±æ˜¯è¯´heartbeatå’Œbroadcastäº‰æŠ¢å¯¹Serverçš„æ›´æ–°</span></span></li></ol><div id="https://www.notion.so/e84a956f718e451dbd3233f7f1bff3d9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></div></details><div id="https://www.notion.so/34e645e35e284fe88cc1323d6ecaaa0c" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">Apply massageçš„æ—¶å€™å‡ºç°äº†é¡ºåºå‡ºé”™çš„é—®é¢˜</span></span></del></div></div></div><details id="https://www.notion.so/1f2aa1c53aef4ed5bf76c430dd9b05f5" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/9aec9834ceea4838bf372b91669e19ec" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>// log
S0 commitIndex: 6                                                                                                                                                    
S0 -&gt; S2 append ok T: 9, LENLOG: 7                                                                                                                                   
                                                                                                               S2 -&gt; S1 T: 9, send heartbeat                         
                                                                                                               S2 -&gt; S1 update success, NEXT: [1 7 7], MATCH: [0 6 0]
                                                                                                               S2 get N: 6                                           
S0 apply msg: {true 106 6 false [] 0 0}                                                                                                                              
S0 ######## CI: 6, cfg.log: [map[0:init server 1:101]                                                                                                                
map[0:init server 1:101 2:102 3:103 4:104 5:105 6:106]                                                                                                               
map[0:init server 1:101 2:102 3:103 4:104 5:105 6:106]]                                                                                 S2 -&gt; S0 T: 7, send heartbeat


// related code
func (cfg *config) checkLogs(i int, m ApplyMsg) (string, bool) {
	err_msg := &quot;&quot;
	v := m.Command
	for j := 0; j &lt; len(cfg.logs); j++ {
		if old, oldok := cfg.logs[j][m.CommandIndex]; oldok &amp;&amp; old != v {
			log.Printf(&quot;%v: log %v; server %v\n&quot;, i, cfg.logs[i], cfg.logs[j])
			// some server has already committed a different value for this entry!
			err_msg = fmt.Sprintf(&quot;commit index=%v server=%v %v != server=%v %v&quot;,
				m.CommandIndex, i, m.Command, j, old)
		}
	}

	DebugLog(dDrop, &quot;S%d ######## CI: %d, cfg.log: %v\n&quot;, i, m.CommandIndex, cfg.logs)
	_, prevok := cfg.logs[i][m.CommandIndex-1]
	cfg.logs[i][m.CommandIndex] = v
	if m.CommandIndex &gt; cfg.maxIndex {
		cfg.maxIndex = m.CommandIndex
	}
	return err_msg, prevok
}</span></span></span></code></pre></div></details><details id="https://www.notion.so/ee108e54189b43548fca297617067347" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/5bfa5f57e09643e6a87d984938308b45" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">é¦–å…ˆï¼Œchanæ˜¯ä¸€ä¸ªfifoã€‚è¿™é‡Œä¼šæ ¹æ®fifoä¸­åå‡ºçš„ApplyMsgè¿›è¡Œåˆ¤æ–­ï¼Œå°†ApplyMsgä¸­çš„ä¿¡æ¯æå–å¹¶å‚¨å­˜åœ¨cfg.logä¸­ã€‚Serveré‡è”åï¼Œä»…æ”¾å…¥æœ€æ–°çš„ApplyMsgä¼šå¯¼è‡´index out of rangeçš„é—®é¢˜ã€‚</span></span></li></ol></div></details><details id="https://www.notion.so/6aa0c199297b4eb1a76fd44eb547e270" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/b4aa6ae5fcf54bd08d15e1d2137d235d" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">ä¹Ÿå°±æ˜¯è¯´ï¼Œéœ€è¦æŒ‰ç…§é¡ºåºå¾€chané‡Œä¸€ä¸ªä¸€ä¸ªæ”¾å…¥ApplyMsgè€Œä¸æ˜¯ä»…æ”¾å…¥æœ€æ–°çš„ApplyMsgã€‚</span></span></li></ol></div></details><div id="https://www.notion.so/1c9878209f3347de97ab0728ecd3272e" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/1fc16c0c754b41ec8247d8cc75eab651" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>âœ go test -run 2B   
Test (2B): basic agreement ...
  ... Passed --   0.5  3   16    4290    3
Test (2B): RPC byte count ...
  ... Passed --   1.3  3   48  113614   11
Test (2B): agreement after follower reconnects ...
  ... Passed --   5.3  3  192   50800    8
Test (2B): no agreement if too many followers disconnect ...
  ... Passed --   3.4  5  264   51340    3
Test (2B): concurrent Start()s ...
  ... Passed --   0.6  3   24    6790    6
Test (2B): rejoin of partitioned leader ...
  ... Passed --   3.9  3  146   35480    4
Test (2B): leader backs up quickly over incorrect follower logs ...
  ... Passed --  14.0  5 2244 1728755  102
Test (2B): RPC counts aren&#x27;t too high ...
  ... Passed --   2.0  3   62   18665   12
PASS
ok      6.824/raft      31.039s</span></span></span></code></pre></div></div><h3 id="https://www.notion.so/6f32d0c97f2c48bab2bb84109ef8d27a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/6f32d0c97f2c48bab2bb84109ef8d27a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2C</span></span></h3><div id="https://www.notion.so/afa837a36ee949a6a1be7623bed76090" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">ä¸€è¿è¡Œåˆ°unrealiableçš„testå°±å‡ºç°out of indexçš„é”™è¯¯ï¼Œç°åœ¨æƒ³æ¥å¥½åƒåœ¨</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">2B</strong></span><span class="SemanticString">ä¸­å¶å°”ä¹Ÿä¼šå‡ºç°è¿™ä¸ªé”™è¯¯ï¼Œè¿˜å€ºäº†å±äºæ˜¯ã€‚</span></span></del></div></div></div><details id="https://www.notion.so/512189265cb14939bc03a5eb3c0d6dee" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/9c8ef634328f4622a105b5c0e434cb05" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>âœ go test -run UnreliableChurn
Test (2C): unreliable churn ...
panic: runtime error: index out of range [8] with length 8

goroutine 22 [running]:
6.824/raft.(*Raft).Apply(0xc0001b2000)
        /home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:596 +0x214
created by 6.824/raft.Make
        /home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:757 +0x3d6
exit status 2
FAIL    6.824/raft      0.300s</span></span></span></code></pre></div></details><details id="https://www.notion.so/b4e63506881045118d7ab6f4cdcb5ec9" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/bb01cc25c81f4e1b97ea3c80685deff2" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">å¾ˆå¥‡æ€ªï¼Œæœ‰æ—¶å¯ä»¥é€šè¿‡ï¼Œæœ‰æ—¶ä¸è¡Œï¼Œ2Cä¸­çš„Unreliableæµ‹è¯•æ”¾å¤§äº†ç³»ç»Ÿçš„å¼±ç‚¹ï¼Œå¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œå¿ƒè·³é—´éš”çš„è®¾ç½®å’Œè¿™ä¸ªé”™è¯¯æ˜¯æœ‰å…³çš„ã€‚åæ¥å‘ç°åŸæ¥æ˜¯å› ä¸ºå»¶è¿Ÿï¼ŒFolloweræ¥å—äº†Indexæ›´å¤è€çš„æ¶ˆæ¯ï¼Œå¹¶è¦†ç›–äº†æ–°çš„æ¶ˆæ¯ã€‚</span></span><pre id="https://www.notion.so/5576443730954b16a1253a84537abc74" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 reconnect...                                                                                                                                  
                              S1 reconnect...                                                                                                    
                                                           S2 reconnect...                                                                       
                                                                                        S3 reconnect...                                          
                                                                                        S3 -&gt; S4 append ok T: 26,                                
                                                                                        LENLOG: 207                                              
                                                                                                                     S4 -&gt; S2 LogInfo {IDX: 192, 
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 LogInfo {IDX: 192,       
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 send to S2, ENTRIES:     
                                                                                                                     {426083054347800940 26 206} 
                                                                                                                     S4 -&gt; S3 update success,    
                                                                                                                     NEXT: [193 205 193 207 193],
                                                                                                                     MATCH: [0 204 0 206 0]      
                                                                                                                     S4 get N: 204               
                                                                                                                     S4, LENLOG: 207, LA: 204    
                                                                                                                     apply msg {CI: 205}         
                                                                                                                     S4 -&gt; S3 LogInfo {IDX: 206, 
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 LogInfo {IDX: 206,       
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 send to S3, ENTRIES:     
                                                                                                                     {426083054347800940 26 206} 
                              S1 -&gt; S4 append ok T: 26,                                                                                          
                              LENLOG: 207                                                                                                        
                                                           S2 append fail, T: 27 large                                                           
                                                           term                                                                                  
                                                                                                                     S4 -&gt; S1 update success,    
                                                                                                                     NEXT: [193 207 193 207 193],
                                                                                                                     MATCH: [0 206 0 206 0]      
                                                                                                                     S4 get N: 206               
                                                                                                                     S4 update commitIndex CI:   
                                                                                                                     206                         
                                                                                                                     S4, LENLOG: 207, LA: 205    
                                                                                                                     apply msg {CI: 206}         
                                                                                                                     S4 -&gt; S2 LogInfo {IDX: 192, 
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 LogInfo {IDX: 192,       
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 send to S2, ENTRIES:     
                                                                                                                     {426083054347800940 26 206} 
                                                                                        S3 commit {CI: 205, LENLOG:                              
                                                                                        207}                                                     
                                                           S2 append fail, T: 27 large                                                           
                                                           term                                                                                  
                                                                                                                     S4 reconnect...             
                              S1 -&gt; S4 append ok T: 26,                                                                                          
                              LENLOG: 206                                                                                                        
                                                                                                                     S4 -&gt; S1 LogInfo {IDX: 206, 
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 LogInfo {IDX: 206,       
                                                                                                                     LENLOG: 207, LOG:           
                                                                                                                     {426083054347800940 26 206}}
                                                                                                                     S4 send to S1, ENTRIES:     
                                                                                                                     {426083054347800940 26 206} 
                                                                                        S3 -&gt; S4 append ok T: 26,                                
                                                                                        LENLOG: 205</span></span></span></code></pre></li><li id="https://www.notion.so/88e5508abfe644aa8e99d28b3f42b30a" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">æœ‰æ—¶å€™ä¼šå‡ºç°ç´¢å¼•å–åˆ°-1çš„æƒ…å†µï¼Œæ’æŸ¥å‡ºæ˜¯appendæ—¶æ¡ä»¶è®¾ç½®æœ‰è¯¯ã€‚</span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Commented">æ­¤å¤–ï¼Œå½“ä¸€ä¸ªServer detachä»¥åï¼Œä¼šæŒç»­å‘åˆ«çš„serverå‘é€ä¿¡æ¯ï¼Œä¸æ–­æ”¶åˆ°fail updateï¼Œè‡ªç„¶ä¼šä¸æ–­å‡å°nextIndexçš„å€¼ã€‚ç›´åˆ°nextIndexå˜ä¸º0,è‡ªå‡åå˜ä¸º-1,ç´¢å¼•è¶Šç•Œã€‚</span></span></span></li></ol></div></details><details id="https://www.notion.so/dd5248ef526f4cfb9502695374dc5ec0" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/80517a7a02f84853927f47290ddedc67" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">ä¿®æ”¹æ¡ç›®æ›´æ–°çš„è§„åˆ™ï¼Œéµå¾ªVoteRequest RPCsä¸­çš„up-to-dateåŸåˆ™ã€‚</span></span><pre id="https://www.notion.so/7e8d85ede8b7473785986f734abf7b49" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>if len(args.Entries) == 0 {
	DebugLog(dLog, &quot;S%d -&gt; S%d recv heartbeat\n&quot;, rf.me, args.LeaderId, rf.currTerm, len(rf.logEntries))
} else {
	rfLastLogIndex, rfLastLogTerm := rf.LogInfoByIndex(len(rf.logEntries) - 1)
	argLastLogIndex, argLastLogTerm := args.Entries[len(args.Entries)-1].Index, args.Entries[len(args.Entries)-1].Term
	if rfLastLogTerm &lt; argLastLogTerm || (rfLastLogTerm == argLastLogTerm &amp;&amp; rfLastLogIndex &lt; argLastLogIndex) {
		rf.logEntries = rf.logEntries[:args.PrevLogIndex+1]
		rf.logEntries = append(rf.logEntries, args.Entries...) // persist
		rf.persist()
	}

	DebugLog(dLog2, &quot;S%d -&gt; S%d append ok T: %d, LENLOG: %d\n&quot;, rf.me, args.LeaderId, rf.currTerm, len(rf.logEntries))
}</span></span></span></code></pre><div id="https://www.notion.so/9115f8b429544a33ac4d0611e625147e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åŒæ—¶è¦æ³¨æ„ä¿®æ”¹replyå¤„ç†éƒ¨åˆ†çš„ä»£ç ï¼Œä¸ç„¶ä¼šå°†nextIndexå’ŒmatchIndexæ›´æ–°æˆæ—§çš„ç´¢å¼•ã€‚</span></span></p></div><pre id="https://www.notion.so/36dbd118498b427fa153f2a65374c219" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>if reply.Success {
	if rf.nextIndex[id] &lt; endOfIndex {
		rf.nextIndex[id] = endOfIndex
		rf.matchIndex[id] = endOfIndex - 1
		DebugLog(dError, &quot;S%d -&gt; S%d update success, NEXT: %v, MATCH: %v\n&quot;, rf.me, id, rf.nextIndex, rf.matchIndex)
		go rf.updateCommitIndex()
	}
	// è®²é“ç†ï¼Œæ›´æ–°æˆåŠŸå°±è¦è¯•è¯•èƒ½ä¸èƒ½update commitIndex
} else {
	rf.nextIndex[id] /= 2
	DebugLog(dError, &quot;S%d -&gt; S%d update failed, NEXT: %d\n&quot;, rf.me, id, rf.nextIndex[id])
}</span></span></span></code></pre></li><li id="https://www.notion.so/b9f81e66efb0481f9f56df1cfa9d1594" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">è´´å‡ºé”™è¯¯ä»£ç </span></span><pre id="https://www.notion.so/182343dcdfbc49b0bddc630d7d3dbd7c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><del class="SemanticString__Fragment SemanticString__Fragment--Strike"><span>if args.PrevLogIndex &gt;= len(rf.logEntries) || rf.logEntries[args.PrevLogIndex].Term != args.PrevLogTerm {
</span></del></span><span class="SemanticString"><span>if args.PrevLogIndex &gt; len(rf.logEntries)-1 || rf.logEntries[args.PrevLogIndex].Term != args.PrevLogTerm {
	reply.Success = false
	DebugLog(dVote, &quot;S%d append fail, diff term\n&quot;, rf.me)
	return
}</span></span></span></code></pre><div id="https://www.notion.so/47268aadee674690812435968b65598c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Commented">æ­¤å¤–ï¼Œæ‰“äº†ä¸ªè¡¥ä¸ï¼Œè®©nextIndexç­‰äºmax(1, nextIndex/2)ï¼Œä¸çŸ¥é“è¿™ä¸ªè¡¥ä¸å¯ä¸å¯ä»¥ç¾åŒ–ã€‚</span></span></span></p></div></li></ol></div></details><div id="https://www.notion.so/f648100fbdbd43ec8bd200018515fe59" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">æœ‰æå°çš„æ¦‚ç‡å‡ºç°é—®é¢˜ï¼šApplyMsgé¡ºåºé”™ä½ã€‚</span></span></del></div></div></div><details id="https://www.notion.so/be703398d02847cea1685fbc2f2a7c5b" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/db042ba8c9fd435d83b1a7d1c348fdba" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Test (2C): Figure 8 (unreliable) ...
3: log map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167]; server map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167 52:9070 53:9855 54:4432 55:1244 56:1773 57:5898 58:2104 59:6905 60:3111 61:6309 62:8721 63:1023 64:4093 65:7848 66:7256 67:6673 68:4167 69:7717 70:9556]
3: log map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167]; server map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167 52:9070 53:9855 54:4432 55:1244 56:1773 57:5898 58:2104 59:6905 60:3111 61:6309 62:8721 63:1023 64:4093 65:7848 66:7256 67:6673 68:4167 69:7717 70:9556]
3: log map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167]; server map[1:2296 2:812 3:2449 4:9494 5:4661 6:4352 7:549 8:7084 9:6810 10:2131 11:5797 12:3999 13:6910 14:5209 15:4842 16:8485 17:8166 18:6914 19:6957 20:2262 21:4452 22:1043 23:1784 24:9148 25:759 26:2552 27:7916 28:6243 29:3173 30:749 31:3392 32:2467 33:1591 34:2306 35:2107 36:9868 37:9973 38:1755 39:8718 40:6107 41:7839 42:2187 43:1553 44:629 45:6596 46:4295 47:1687 48:9196 49:2304 50:54 51:6167 52:9070 53:9855 54:4432 55:1244 56:1773 57:5898 58:2104 59:6905 60:3111 61:6309 62:8721 63:1023 64:4093 65:7848 66:7256 67:6673 68:4167 69:7717 70:9556]
apply error: commit index=52 server=3 2540 != server=4 9070</span></span></span></code></pre></div></details><details id="https://www.notion.so/75654e0660a340adbbcadc7d0b418930" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/32ae08d9f7514fedbe0ff73b1b7ac607" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">æ²¡æ’æŸ¥å‡ºæ¥</span></span></li></ol></div></details><details id="https://www.notion.so/a809cc566b9e491cb8a1d08381c38d2e" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/d27d855a2e11424ab64f0a7b4759327e" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">å°†AppendEntriesä¸­çš„ </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">defer rf.applyCh.Signal()</code></span><span class="SemanticString"> å˜æˆäº† </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">rf.applyCh.Signal()</code></span></span></li></ol></div></details><div id="https://www.notion.so/f882476d57a74eba9fd6339471560a9a" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Commented">PASS LOG</span></span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/e3d435da057843ff9030cf1f527ce4e2" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>âœ go test -run 2C                                               
Test (2C): basic persistence ...
  ... Passed --   3.1  3   78   18954    6
Test (2C): more persistence ...
  ... Passed --  14.4  5 1036  200240   16
Test (2C): partitioned leader and one follower crash, leader restarts ...
  ... Passed --   1.3  3   36    8539    4
Test (2C): Figure 8 ...
  ... Passed --  27.0  5 1180  256006   58
Test (2C): unreliable agreement ...
  ... Passed --   1.7  5 1048  345471  246
Test (2C): Figure 8 (unreliable) ...
  ... Passed --  33.6  5 19228 18476272  138
Test (2C): churn ...
  ... Passed --  16.4  5 6992 9763562 1432
Test (2C): unreliable churn ...
  ... Passed --  16.1  5 4236 5664994  384
PASS
ok      6.824/raft      113.623s</span></span></span></code></pre></div></div><h3 id="https://www.notion.so/d3ef8ee4d8f549459c28cd4077377ab2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d3ef8ee4d8f549459c28cd4077377ab2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2D</span></span></h3><blockquote id="https://www.notion.so/3fb57bb3937848a29b6130b3e4826a53" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">åœ¨2Dä¸­ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œåˆ‡ç‰‡åº•å±‚æ˜¯æ•°ç»„å®ç°ï¼Œå¦‚æœæƒ³è¦è®©GC reachåˆ°è¢«snapshotæ‰çš„æ— ç”¨å†…å­˜ï¼Œå°±éœ€è¦é‡æ–°åˆ›å»ºåˆ‡ç‰‡ï¼ŒåŸåˆ‡ç‰‡æŒ‡é’ˆç½®ç©ºã€‚</span></span></blockquote><div id="https://www.notion.so/53614c5c6dd743d58d80ce5a11d8eb25" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">æœ‰æ¦‚ç‡å‡ºç°é—®é¢˜ï¼šåœ¨æ›´æ–°commitIndexçš„æ—¶å€™å‡ºç°out of Indexé—®é¢˜ã€‚</span></span></del></div></div></div><details id="https://www.notion.so/efb293bfeaf641c3abbb9b472ae0c6e6" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/d38af99a2f07495c8f63499a1b4b76f8" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Test (2C): unreliable churn ...
panic: runtime error: index out of range [1656] with length 1656

goroutine 106315 [running]:
6.824/raft.(*Raft).updateCommitIndex(0xc000136200)
        /home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:647 +0x345
created by 6.824/raft.(*Raft).broadcastAppendEntries.func1
        /home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:622 +0x796
exit status 2</span></span></span></code></pre></div></details><details id="https://www.notion.so/051514498a634d22b5e69b7ce962d7f1" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/1c312d8e4a074907986009184322dd10" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">updateCommitIndexå‡½æ•°åŸæœ¬æ˜¯ä½¿ç”¨åç¨‹å®ç°çš„ï¼Œæ‰€ä»¥æœ‰æå°çš„æ¦‚ç‡ï¼Œåœ¨updateCommitIndexä¹‹å‰ï¼Œå®Œæˆäº†Leaderè½¬æ¢ã€é‡æ–°å¹¿æ’­ã€æ›´æ–°æ–°çš„CommitIndexè¿™ä¸€ç³»åˆ—æ“ä½œã€‚ä½¿å¾—ä¸€å¼€å§‹çš„æ›´æ–°åç¨‹å‡ºç°è¶Šç•Œã€‚</span></span></li></ol></div></details><details id="https://www.notion.so/bb4efcce59a04526b21d4b2007494843" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/84530e7ff0f04b49a707f9c941c7ea33" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">çº¿æ€§æ‰§è¡ŒupdateCommitIndexï¼Œå»é™¤å‡½æ•°ä¸­çš„åŠ é”æ“ä½œï¼Œç»Ÿä¸€ç”±ä¸»åç¨‹ç®¡ç†é”</span></span><pre id="https://www.notion.so/2eaed3c5cae841bbbb3289f07aed8450" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>func (rf *Raft) updateCommitIndex() {
	// rf.mu.Lock()
	// defer rf.mu.Unlock()

	var dupMatchIndex []int
	dupMatchIndex = append(dupMatchIndex, rf.matchIndex...)
	dupMatchIndex[rf.me] = rf.logEntries[len(rf.logEntries)-1].Index
	sort.Ints(dupMatchIndex)
	DebugLog(dError, &quot;S%d get N: %d\n&quot;, rf.me, dupMatchIndex[(len(rf.peers)-1)/2])

	var N int = dupMatchIndex[(len(rf.peers)-1)/2]
	if N &gt; rf.commitIndex &amp;&amp; rf.logEntries[N].Term == rf.currTerm {
		rf.commitIndex = N
		defer rf.applyCond.Signal()
		DebugLog(dError, &quot;S%d update commitIndex CI: %d\n&quot;, rf.me, rf.commitIndex)
	}
}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/05f48fe987c342afa373bd00f24148a9" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">æ­»é”é—®é¢˜ï¼š</span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Commented">ä¸€å¼€å§‹æ‰§è¡ŒSnapshotå‡½æ•°å°±å¡åœ¨è·å¾—é”çš„æ“ä½œè¿™é‡Œã€‚</span></span></span></del></div></div></div><details id="https://www.notion.so/fb4c1c6474f5477c99badc4d92f10390" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/2a4a09c856184f29b5b55c15660b95ca" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S2 LogInfo {IDX: 13,                                                          
                                                      LENLOG: 14, LOG:                                                              
                                                      {8815208668614808923 1                                                        
                                                      13}}                                                                          
                                                      S2 -&gt; S1 append ok T: 1,                                                      
                                                      LENLOG: 14                                                                    
                            S1 start create snapshot                                                                                
                            LII: 9, T: 1                                                                                            
                            S1 start create snapshot,                                                                               
                            before lock                                                                                             
                            S1, LENLOG: 14, LA: 1                                                                                   
                            apply msg {CI: 10}                                                                                      
S0 convert to candidate,                                                                                                            
calling election T: 1                                                                                                               
S0 LogInfo {IDX: 1, LENLOG:                                                                                                         
2, LOG:                                                                                                                             
{7859782014890577642 1 1}}                                                                                                          
                                                      S2 C1 ask for vote, T: 2                                                      
                            S1 C1 ask for vote, T: 2                                                                                
                                                      S2 LogInfo {IDX: 13,                                                          
                                                      LENLOG: 14, LOG:                                                              
                                                      {8815208668614808923 1                                                        
                                                      13}}                                                                          
                                                      S2 -&gt; S0 vote false, old                                                      
                                                      log                                                                           
                                                      S2 convert to candidate,                                                      
                                                      calling election T: 2                                                         
                                                      S2 LogInfo {IDX: 13,                                                          
                                                      LENLOG: 14, LOG:                                                              
                                                      {8815208668614808923 1                                                        
                                                      13}}                                                                          
                            S1 C1 ask for vote, T: 3                                                                                
S0 C1 ask for vote, T: 3                                                                                                            
S0 LogInfo {IDX: 1, LENLOG:                                                                                                         
2, LOG:                                                                                                                             
{7859782014890577642 1 1}}                                                                                                          
S0 -&gt; S2 vote true, from T:                                                                                                         
2 to CT: 3                                                                                                                          
                                                      S2 convert to leader at                                                       
                                                      T: 3                                                                          
                                                      S2 -&gt; S1 LogInfo {IDX:                                                        
                                                      13, LENLOG: 14, LOG:                                                          
                                                      {8815208668614808923 1                                                        
                                                      13}}                                                                          
                                                      S2 LogInfo {IDX: 13,                                                          
                                                      LENLOG: 14, LOG:                                                              
                                                      {8815208668614808923 1                                                        
                                                      13}}</span></span></span></code></pre></div></details><details id="https://www.notion.so/63e47ff6be574d5da499fa2c62bd76f0" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/436bbafc103c496ea5d806323a75bbe0" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">å¿«ç…§çš„é—´éš”æ˜¯æ¯10æ¡commandè¿›è¡Œä¸€æ¬¡å¿«ç…§ï¼Œå› æ­¤èŠ‚ç‚¹åœ¨è¿›è¡Œå°†å·²ç»æäº¤äº†çš„æŒ‡ä»¤å‘é€åˆ°applyChè¿›è¡Œæ‰§è¡Œçš„æ—¶å€™ä¸èƒ½è·å–æœ‰rf.muè¿™ä¸ªäº’æ–¥é”ï¼Œå› ä¸ºåœ¨ä½ æäº¤æŒ‡ä»¤å¹¶å°†è¯¥æŒ‡ä»¤å‘é€åˆ°applyChæ‰§è¡Œçš„åŒæ—¶ï¼Œæµ‹è¯•è„šæœ¬ä¼šè°ƒç”¨Snapshotå‡½æ•°è¿›è¡Œå¿«ç…§ï¼Œä½†æ˜¯æˆ‘è®¾è®¡çš„è¿™ä¸ªå‡½æ•°ä¹Ÿéœ€è¦è·å–rf.muäº’æ–¥é”ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¿›å…¥æ­»é”çŠ¶æ€ï¼šæ— æ³•è·å–rf.muäº’æ–¥é”è¿›è¡Œå¿«ç…§ï¼Œå¦ä¸€è¾¹æ˜¯éœ€è¦ç­‰å¿«ç…§ç»“æŸæ‰èƒ½ç»§ç»­æäº¤æŒ‡ä»¤å¹¶æ‰§è¡Œï¼Œä»¥åŠåç»­åŠ¨ä½œã€‚</span></span></li></ol></div></details><details id="https://www.notion.so/03c60d54823847e79b9218bbe1c4a3ac" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/5877443c66b64ef288fd61effebe4c0b" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åœ¨Applyå‡½æ•°ä¸­è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹</span></span><pre id="https://www.notion.so/c924dee906324100a7810af662f45f58" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	++	rf.mu.Unlock()
			rf.applyCh &lt;- msg
	++	rf.mu.Lock()</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/c83d60d349824c26b1a62b128e10bae2" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">AppendEntriesä¸­å‡ºç°è´Ÿæ•°çš„Logç´¢å¼•</span></span></del></div></div></div><details id="https://www.notion.so/61a4dd1b1d224aa0aba368f33c878498" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/f8387e99f51544b2ab8eb3812dbf075d" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åŸæ¥åªéœ€è¦æ£€æŸ¥args.PrevLogIndexå°äºç­‰äºLogæœ€åä¸€é¡¹çš„ç´¢å¼•å€¼ã€‚ä½†æ˜¯åœ¨å¼•å…¥snapshotåè¿˜éœ€è¦æ£€æŸ¥args.PrevLogIndexå¤§äºç­‰äºlastIncludedIndexï¼Œå› ä¸ºå†å²çš„AppendEntries RPCå¯ä»¥å»¶è¿ŸæŠµè¾¾</span></span><pre id="https://www.notion.so/b37b5abf7fda418ca2ddb025c66fd222" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if args.PrevLogIndex &gt; rf.logEntries[len(rf.logEntries)-1].Index ||
		rf.logEntries[args.PrevLogIndex-rf.snapshot.LastIncludedIndex].Term != args.PrevLogTerm { // ATTENTION è¿™é‡Œå¯èƒ½ä¼šè¶Šç•Œï¼Œè¦å‡å»lastincludedindex
		reply.Success = false
		DebugLog(dVote, &quot;S%d append fail, diff term\n&quot;, rf.me)
		return
	}</span></span></span></code></pre></li></ol></div></details><details id="https://www.notion.so/6dc7bfb406b348648d8568a323219994" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/023faf2752f945a684fe5f4ccdd9daf2" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥å°†replyçš„successç½®trueå¹¶è¿”å›ï¼Œå› ä¸ºå¯¹äºæˆåŠŸæ—¶è¿”å›å€¼çš„å¤„ç†å·²ç»è€ƒè™‘åˆ°äº†å»¶è¿Ÿæ¶ˆæ¯ï¼ˆ2Cï¼‰</span></span><pre id="https://www.notion.so/b225de38c231465c9faa16fa88296df9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if rf.snapshot.LastIncludedIndex &gt; args.PrevLogIndex {
		reply.Success = true
		DebugLog(dVote, &quot;S%d append success, snapshot interrupt...\n&quot;, rf.me)
		return
	}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/9b8f8bf1338541a6879855c368b13d6b" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Commented">broadcastä¸­å‡ºç°è´Ÿæ•°çš„Logç´¢å¼•</span></span></span></del></div></div></div><details id="https://www.notion.so/b67a2499d0074de2b99bd570ee4b04f1" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/fa086fd0a9f0469fbd8f72fee1dc4bcd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">nextIndex[0] == snapshot.lastIncludedIndex</span></span></p></div><pre id="https://www.notion.so/74004a4c30ac4c2e88f7ec32c0aa7ecd" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S1 -&gt; S0 LogInfo {IDX: 108,                                                                                                 
                                 LENLOG: 8, LOG:                                                                                                             
                                 {5178380306894727311 1 116}},                                                                                               
                                 NEXT: [109 1 117], SS: {109 1}                                                                                              
                                                                S2, LENLOG: 18, LA: 108 apply                                                                
                                                                msg {CI: 109}                                                                                
                                                                S2, LENLOG: 18, LA: 108 apply                                                                
                                                                msg {CI: 110}                                                                                
                                                                S2 -&gt; S1 recv heartbeat

#################################################
panic: runtime error: index out of range [-1]

goroutine 890 [running]:
6.824/raft.(*Raft).LogInfoByIndex(0xc000134100, 0xffffffffffffffff)
	/home/humborn/Code/go/MIT-6.5840/src/raft/util.go:101 +0xbd
6.824/raft.(*Raft).broadcastAppendEntries.func1(0x0)
	/home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:716 +0x84c
created by 6.824/raft.(*Raft).broadcastAppendEntries
	/home/humborn/Code/go/MIT-6.5840/src/raft/raft.go:669 +0x15f
exit status 2</span></span></span></code></pre></div></details><details id="https://www.notion.so/7cfe0b08897343de9fc68d36aa9a7952" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/9549d888b4d04e7e90b84fdd8b486379" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åŒæ ·çš„ï¼Œå¹¿æ’­å‘å¸ƒäº†åç¨‹åå¹¶æœªç«‹å³æ‰§è¡Œï¼Œè€Œsnapshotåœ¨åç¨‹è¿è¡Œä¹‹å‰æ›´æ–°äº†lastIncludedIndexã€‚ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç°å‡ºé”™çš„Logçš„ç´¢å¼•éƒ½æ˜¯mod 10ä½™9çš„ï¼Œå¯¹åº”äº†snapshotçš„ç”Ÿæˆè§„å¾‹ï¼ŒéªŒè¯äº†çŒœæƒ³ã€‚</span></span><pre id="https://www.notion.so/8c15a8bcb5684756915d984af8a5f19a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if args.PrevLogIndex &gt; rf.logEntries[len(rf.logEntries)-1].Index ||
		rf.logEntries[args.PrevLogIndex-rf.snapshot.LastIncludedIndex].Term != args.PrevLogTerm { // ATTENTION è¿™é‡Œå¯èƒ½ä¼šè¶Šç•Œï¼Œè¦å‡å»lastincludedindex
		reply.Success = false
		DebugLog(dVote, &quot;S%d append fail, diff term\n&quot;, rf.me)
		return
	}</span></span></span></code></pre></li></ol></div></details><details id="https://www.notion.so/9a0427d34b3f431ba5dfebfb592fb976" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/0a80fe07be1a4458b604c76edcbeee56" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">å°†å¹¿æ’­æ¡ä»¶ä¸­è§¦å‘å¿«ç…§åŠ è½½çš„æ¡ä»¶ç”± &lt; æ”¹ä¸º â‰¤ ã€‚</span></span><pre id="https://www.notion.so/393d441633d54a79b2cc00fd456b835a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>go func(id int) {
			rf.mu.Lock()
			// éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“rf.nextIndex[id] == rf.logEntries[len(rf.logEntries)-1].Index+1ï¼Œå¯¹åº”çš„æ˜¯å‘é€heartbeatçš„æƒ…å†µ
			if rf.nextIndex[id] &gt; rf.logEntries[len(rf.logEntries)-1].Index+1 {
				rf.mu.Unlock()
				return
			}

			</span></span><span class="SemanticString"><del class="SemanticString__Fragment SemanticString__Fragment--Strike"><span>if rf.nextIndex[id] &lt; rf.snapshot.LastIncludedIndex {</span></del></span><span class="SemanticString"><span>
			if rf.nextIndex[id] &lt;= rf.snapshot.LastIncludedIndex {</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/9ba88ea8a1ba47e79b8ddec0903f4e4e" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">ApplyMsgé¡ºåºé”™ä½ç¬¬äºŒå¼¹ï¼Œè¯¦å¾ª2Cä¸­çš„ç¬¬äºŒä¸ªé—®é¢˜</span></span></del></div></div></div><details id="https://www.notion.so/cbc53a604bf644d78d4b3af0383cd7bb" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/e38d1883682c4c6ca36fd40b6a9fda41" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Test (2D): snapshots basic ...
apply error: server 0 apply out of order, expected index 100, got 101
exit status 1
FAIL    6.824/raft      1.269s</span></span></span></code></pre></div></details><details id="https://www.notion.so/dc189bdd6bbc48f287e233d1e5da3987" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/dfc60970b3414e76bf68e66e3362cbdf" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åœ¨åŸæ¥çš„Applyå®ç°ä¸­ï¼Œå¾ªç¯ä¸­çš„cidåªè¢«åˆå§‹åŒ–äº†ä¸€æ¬¡ï¼Œä½†æ˜¯åœ¨è¿™é‡Œï¼Œæ¯æ¬¡å¾ªç¯ä¸­ä¼šéšæ’å…¥è®°å½•çš„æ•°é‡å¢åŠ ç”Ÿæˆsnapshotï¼Œæ”¹å˜åŸæ¥çš„åˆå§‹å€¼ã€‚</span></span><pre id="https://www.notion.so/d2a2092ce63c4594998c69b868bf1e46" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>		for cid := max(rf.lastApplied, rf.snapshot.LastIncludedIndex) + 1; cid &lt;= rf.commitIndex; cid++ {
			DebugLog(dError, &quot;S%d, LENLOG: %d, LA: %d apply msg {CI: %d} \n&quot;, rf.me, len(rf.logEntries), rf.lastApplied, cid)
			msg := ApplyMsg{
				CommandValid: true,
				Command:      rf.logEntries[cid-rf.snapshot.LastIncludedIndex].Command,
				CommandIndex: cid,
			}
			rf.mu.Unlock()
			rf.applyCh &lt;- msg
			rf.mu.Lock()
		}</span></span></span></code></pre></li></ol></div></details><details id="https://www.notion.so/9bdd505075684d2393a322409fcc591b" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/dff51f1ee7c3414283962ebc73ecdb67" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">å¤šæ¬¡åˆå§‹åŒ–ã€‚</span></span><pre id="https://www.notion.so/e07f7ce98c5f4bb1a914932b9b939d4f" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>		cid := max(rf.lastApplied, rf.snapshot.LastIncludedIndex) + 1
		for cid &lt;= rf.commitIndex {
			DebugLog(dError, &quot;S%d, LENLOG: %d, LA: %d apply msg {CI: %d} \n&quot;,
				rf.me, len(rf.logEntries), rf.lastApplied, cid)
			msg := ApplyMsg{
				CommandValid: true,
				Command:      rf.logEntries[cid-rf.snapshot.LastIncludedIndex].Command,
				CommandIndex: cid,
			}
			rf.mu.Unlock()
			rf.applyCh &lt;- msg
			rf.mu.Lock()
			rf.lastApplied = cid
			cid = max(rf.lastApplied, rf.snapshot.LastIncludedIndex) + 1
		}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/c79d331934464ed181f55368459ef13a" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">é¦–å…ˆï¼Œå¯ä»¥çŸ¥é“ï¼Œapply out of orderæœ‰ä¸¤ç§å½¢æ€ï¼Œä¸€ç§æ˜¯æ¥æ”¶åˆ°äº†æœ‰å»¶è¿Ÿçš„ä¿¡æ¯ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯æ¥æ”¶åˆ°äº†æœªæ¥çš„ä¿¡æ¯ã€‚ä»¥InstallSnapshot RPCä¸ºä¾‹ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢è¿™æ®µä»£ç å¯¹å»¶è¿Ÿä¿¡æ¯è¿›è¡Œè¿‡æ»¤ã€‚ä½†æ˜¯raftçš„Termã€commitIndexå’ŒlastAppliedç­‰ç´¢å¼•éƒ½æ˜¯å®Œå¤‡çš„ï¼Œè®²é“ç†ä¸ä¼šå‡ºç°â€œæœªæ¥çš„â€ä¿¡æ¯ã€‚</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/66a66481640448b89e55894ca3115dd8" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if rf.commitIndex &lt; args.LastIncludedIndex {
		rf.commitIndex = args.LastIncludedIndex
	}
	if rf.lastApplied &lt; args.LastIncludedIndex {
		rf.lastApplied = args.LastIncludedIndex
	}</span></span></span></code></pre></div></div><details id="https://www.notion.so/cd932309114d4436883aa710b0c05a68" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/f09203cbb59443ef9ba5c7df678dd1e5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>apply error: server 0 apply out of order, expected index 230, got 231
exit status 1
FAIL	6.824/raft	1.852s</span></span></span></code></pre></div></details><details id="https://www.notion.so/b09f53ec07524c31ab56b0d70cfa08bf" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/6fd2af3e553540bd86820835ff68f8d9" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åœ¨æµ‹è¯•ä»£ç ä¸­ï¼Œsnapshotåœ¨ApplyChä¸­è¢«æ¥æ”¶åï¼Œä¼šä»¥è‡ªèº«çš„lastIncludedIndexåˆ·æ–°service serverçš„å¯¹åº”å‚æ•°ï¼Œé€ æˆâ€œç‰ˆæœ¬å›é€€â€ã€‚</span></span></li></ol></div></details><details id="https://www.notion.so/fbbf594074f34b85ab390dab44c86042" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/bda000359f2d4110a4535c822be60d1c" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">åœ¨InstallSnapshotä¸­ä¸lastAppliedè¿›è¡Œæ¯”è¾ƒåˆ¤æ–­è¿‡æ»¤â€œç‰ˆæœ¬å›é€€â€</span></span><pre id="https://www.notion.so/6bd92357506b43e4944c05d19c20b51d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>	if args.LastIncludedIndex &lt;= rf.snapshot.LastIncludedIndex ||
		args.LastIncludedIndex &lt;= rf.lastApplied {
		rf.mu.Unlock()
		return
	}</span></span></span></code></pre></li></ol></div></details><div id="https://www.notion.so/822ec6395bad4bb599522d9b76d0dd3c" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">ä¼šæŠ¥è«åå…¶å¦™çš„é”™è¯¯</span></span></del></div></div></div><details id="https://www.notion.so/035664ca2ada45b0b56c9513c51713b6" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Debug log</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/9bc52dc561684e63a1e7261e38d84e7f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">ç¬¬ä¸€åˆ—çš„Indexå’ŒLIIä¸å¯¹åº”é€ æˆçš„</span></span></p></div><pre id="https://www.notion.so/c4c366f02da14512ab188ab4280f2e67" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>S0 ingestSnap: snapshot doesn&#x27;t match                                                                                                                    
m.SnapshotIndex, INDEX: 39, LII: 29                                                                                                                      
S0 C46 install snapshot, IDX: 39 T: 1,                                                                                                                   
start from 39 to 46                                                                                                                                      
#############################################################################

apply error: server 0 snapshot doesn&#x27;t match m.SnapshotIndex
exit status 1
FAIL	6.824/raft	1.041s</span></span></span></code></pre></div></details><details id="https://www.notion.so/c024abb9b1ba4ca38b1b2b26a2d47533" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ’æŸ¥å‡ºçš„é—®é¢˜</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/f518ddd4df1446e1bad65bdb18a7edcd" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">ç”±äºåœ¨å‰é¢çš„é—®é¢˜æ’æŸ¥ä¸­å·²ç»åŸºæœ¬è§£å†³äº†out of orderçš„é—®é¢˜ï¼Œæ¨æµ‹å‡ºç°è¿™ç§æƒ…å†µçš„åŸå› æ˜¯SaveStateAndSnapshotå‡½æ•°å­˜åœ¨å…ˆåæ‰§è¡Œé¡ºåºï¼Œåç¨‹æœ‰å»¶è¿Ÿï¼Œä½¿å¾—ä¿å­˜çš„æ—¶å€™æ²¡æœ‰èµ·åˆ°æ‹¦æˆªout of orderçš„ä½œç”¨</span></span></li></ol></div></details><details id="https://www.notion.so/431652892e114f66bb9e4c9b1e3f0f3e" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆ</span></span></summary><div class="Toggle__Content"><ol class="NumberedListWrapper"><li id="https://www.notion.so/cc0aed15451549668d152247da63dedd" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">æŠŠæ‰€æœ‰çš„rf.mu.Lock()ç»Ÿç»Ÿç§»åˆ°SaveStateAndSnapshotå‡½æ•°åé¢ä¿è¯çº¿æ€§é¡ºåºã€‚</span></span></li></ol></div></details><div id="https://www.notion.so/989226ac5c2c4b4eb6c8524083b7fac4" class="ColorfulBlock ColorfulBlock--ColorDefault ToDo"><div class="ToDo__Content"><div class="ToDo__Icon"><div class="IconCheckboxChecked"><svg viewBox="0 0 14 14"><polygon points="5.5 11.9993304 14 3.49933039 12.5 2 5.5 8.99933039 1.5 4.9968652 0 6.49933039"></polygon></svg></div></div><div class="ToDo__Title ToDo__Title--done"><del><span class="SemanticStringArray"><span class="SemanticString">PASS LOG</span></span></del></div></div><div class="ToDo__Children"><pre id="https://www.notion.so/f462bd0884964c728f5a61f87bfe0236" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>âœ go test -run 2D              
Test (2D): snapshots basic ...
  ... Passed --   1.8  3  506  164008  235
Test (2D): install snapshots (disconnect) ...
  ... Passed --  32.9  3 2444 1245742  316
Test (2D): install snapshots (disconnect+unreliable) ...
  ... Passed --  38.7  3 3604 1300893  327
Test (2D): install snapshots (crash) ...
  ... Passed --  24.5  3 1148  879888  334
Test (2D): install snapshots (unreliable+crash) ...
  ... Passed --  33.0  3 1432  692990  322
Test (2D): crash and restart all servers ...
  ... Passed --   6.7  3  244   64312   54
PASS
ok      6.824/raft      137.622s</span></span></span></code></pre></div></div></article>
  <footer class="Footer">
  <div>&copy; humblog 2022</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>